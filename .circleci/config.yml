version: 2.1
orbs:
  cloudrun: circleci/gcp-cloud-run@1.0.2
  slack: circleci/slack@4.2

###################
#  SLACK
###################

slack-fail-post-step: &slack-fail-post-step
  post-steps:
    - slack/notify:
        event: fail
        channel: alertes_data
        branch_pattern: "^(master|production)"
        custom: |
          {
            "text": "",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "‚ùå *Echec* #${CIRCLE_BUILD_NUM} `${CIRCLE_PROJECT_REPONAME}` sur `${CIRCLE_BRANCH}`"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Job"
                    },
                    "url": "${CIRCLE_BUILD_URL}"
                  }
                ]
              }
            ]
          }

###################
#  Aliases
###################

deploy_on_dev_commons: &deploy_on_dev_commons
  filters:
    branches:
      only:
        - production
  context:
    - DATA_GCP
    - DATA_GCP_DEV
    - Slack
  <<: *slack-fail-post-step

###################
#  WORKFLOWS
###################

workflows:
  version: 2
  run-checks:
    jobs:
      - linter
      # Recommendation jobs
      # -------------------

      #- recommendation-db-install:
      #    requires:
      #      - linter
      #    context:
      #      - Slack
      #    <<: *slack-fail-post-step
      #
      #- recommendation-db-tests:
      #    requires:
      #      - recommendation-db-install
      #    context:
      #      - Slack
      #    <<: *slack-fail-post-step

      - recommendation-api-build:
          requires:
            - linter
          context:
            - Slack
          <<: *slack-fail-post-step

      - recommendation-api-tests:
          requires:
            - recommendation-api-build
          context:
            - Slack
          <<: *slack-fail-post-step

      #- api-integration-tests:
      #    env: dev
      #    api_token: $API_TOKEN_DEV
      #    name: api-integration-tests-dev
      #   requires:
      #      - recommendation-api-tests
      #    filters:
      #      branches:
      #        ignore:
      #          - master
      #          - production
      #    context:
      #      - DATA_GCP_DEV
      #      - Slack
      #    <<: *slack-fail-post-step

      - build_and_deploy_api:
          name: build_and_deploy_api_staging
          api-instance-name: apireco-stg
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - api-integration-tests:
          name: api-integration-tests-staging
          env: staging
          api_token: $API_TOKEN_STG
          requires:
            - build_and_deploy_api_staging
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - build_and_deploy_api:
          name: build_and_deploy_api_production
          api-instance-name: apireco-prod
          requires:
            - recommendation-api-tests
            #- recommendation-db-tests
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - api-integration-tests:
          name: api-integration-tests-prod
          env: production
          api_token: $API_TOKEN_PROD
          requires:
            - build_and_deploy_api_production
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - algo-training-install:
          requires:
            - linter
          context:
            - Slack
          <<: *slack-fail-post-step

      - algo-training-tests:
          requires:
            - algo-training-install
          context:
            - Slack
            - DATA_GCP
            - DATA_GCP_EHP
          <<: *slack-fail-post-step

      - record-linkage-install:
          requires:
            - linter
          context:
            - Slack
          <<: *slack-fail-post-step

      - record-linkage-tests:
          requires:
            - record-linkage-install
          context:
            - Slack
            - DATA_GCP
            - DATA_GCP_EHP
          <<: *slack-fail-post-step

      # Composer jobs
      # -------------
      - orchestration-install:
          requires:
            - linter
          context:
            - Slack
          <<: *slack-fail-post-step

      - orchestration-tests:
          requires:
            - orchestration-install
          context:
            - Slack
            - DATA_GCP
            - DATA_GCP_EHP
          <<: *slack-fail-post-step

      - composer-deploy:
          name: staging-composer-deploy
          requires:
            - orchestration-tests
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - composer-deploy:
          name: production-composer-deploy
          requires:
            - orchestration-tests
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      # Cloud Function jobs
      # -------------------

      - cloud-function-deploy:
          name: addresses-cloud-function-deploy-stg
          cloud-function-name: addresses_import_stg
          cloud-function-folder: jobs/etl_jobs/external/addresses
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: addresses-cloud-function-deploy-prod
          cloud-function-name: addresses_import_prod
          cloud-function-folder: jobs/etl_jobs/external/addresses
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: downloads-cloud-function-deploy-stg
          cloud-function-name: downloads_stg
          cloud-function-folder: downloads-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: qualtrics-cloud-function-deploy-stg
          cloud-function-name: qualtrics_import_stg
          cloud-function-folder: qualtrics-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: appsflyer-cloud-function-deploy-stg
          cloud-function-name: appsflyer_import_stg
          cloud-function-folder: jobs/etl_jobs/external/appsflyer
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: downloads-cloud-function-deploy-prod
          cloud-function-name: downloads_prod
          cloud-function-folder: downloads-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: qualtrics-cloud-function-deploy-prod
          cloud-function-name: qualtrics_import_prod
          cloud-function-folder: qualtrics-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: appsflyer-cloud-function-deploy-prod
          cloud-function-name: appsflyer_import_prod
          cloud-function-folder: jobs/etl_jobs/external/appsflyer
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: contentful-cloud-function-deploy-stg
          cloud-function-name: contentful_stg
          cloud-function-folder: contentful-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: contentful-cloud-function-deploy-prod
          cloud-function-name: contentful_prod
          cloud-function-folder: contentful-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: siren-cloud-function-deploy-stg
          cloud-function-name: siren_import_stg
          cloud-function-folder: siren-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: siren-cloud-function-deploy-prod
          cloud-function-name: siren_import_prod
          cloud-function-folder: siren-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: dms-cloud-function-deploy-stg
          cloud-function-name: dms_stg
          cloud-function-folder: dms-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: dms-cloud-function-deploy-prod
          cloud-function-name: dms_prod
          cloud-function-folder: dms-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: import-adage-cloud-function-deploy-stg
          cloud-function-name: adage_import_stg
          cloud-function-folder: jobs/etl_jobs/external/adage
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: import-adage-cloud-function-deploy-prod
          cloud-function-name: adage_import_prod
          cloud-function-folder: jobs/etl_jobs/external/adage
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: import-typeform-adage-reference-request-stg
          cloud-function-name: typeform_adage_reference_request_stg
          cloud-function-folder: typeform-adage-reference-request-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: import-typeform-adage-reference-request-prod
          cloud-function-name: typeform_adage_reference_request_prod
          cloud-function-folder: typeform-adage-reference-request-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step
      
      - cloud-function-deploy:
          name: metabase-archiving-stg
          cloud-function-name: metabase_archiving_stg
          cloud-function-folder: metabase-archiving-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: metabase-archiving-prod
          cloud-function-name: metabase_archiving_prod
          cloud-function-folder: metabase-archiving-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step
      
      - cloud-function-deploy:
          name: sendinblue-import-stg
          cloud-function-name: sendinblue_import_stg
          cloud-function-folder: sendinblue-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step
          
      - cloud-function-deploy:
          name: cold-data-stg
          cloud-function-name: cold_data_stg
          cloud-function-folder: cold-data-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - master
          context:
            - DATA_GCP
            - DATA_GCP_EHP
            - Slack
          <<: *slack-fail-post-step

      - cloud-function-deploy:
          name: sendinblue-import-prod
          cloud-function-name: sendinblue_import_prod
          cloud-function-folder: sendinblue-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step
          
      - cloud-function-deploy:
          name: cold-data-prod
          cloud-function-name: cold_data_prod
          cloud-function-folder: cold-data-function-source
          requires:
            - linter
          filters:
            branches:
              only:
                - production
          context:
            - DATA_GCP
            - DATA_GCP_PROD
            - Slack
          <<: *slack-fail-post-step

      # Slack alerts jobs
      # ----------------
      - slack-alert:
          name: slack-alert-production
          destination_env: Production
          context: Slack
          filters:
            branches:
              only:
                - production
          requires:
            - production-composer-deploy
            - api-integration-tests-prod
            - addresses-cloud-function-deploy-prod
            - downloads-cloud-function-deploy-prod
            - qualtrics-cloud-function-deploy-prod
            - appsflyer-cloud-function-deploy-prod
            - contentful-cloud-function-deploy-prod
            - siren-cloud-function-deploy-prod
            - dms-cloud-function-deploy-prod
            - import-adage-cloud-function-deploy-prod
            - import-typeform-adage-reference-request-prod
            - metabase-archiving-prod
            - cold-data-prod
            - sendinblue-import-prod

      - slack-alert:
          name: slack-alert-staging
          destination_env: Staging
          context: Slack
          filters:
            branches:
              only:
                - master
          requires:
            - staging-composer-deploy
            - api-integration-tests-staging
            - addresses-cloud-function-deploy-stg
            - downloads-cloud-function-deploy-stg
            - qualtrics-cloud-function-deploy-stg
            - appsflyer-cloud-function-deploy-stg
            - contentful-cloud-function-deploy-stg
            - siren-cloud-function-deploy-stg
            - dms-cloud-function-deploy-stg
            - import-adage-cloud-function-deploy-stg
            - import-typeform-adage-reference-request-stg
            - metabase-archiving-stg
            - cold-data-stg
            - sendinblue-import-stg

  # ----------------
  # Workflow to deploy on dev
  # ----------------

  deploy_on_dev:
    jobs:
      - composer-deploy:
          name: dev-composer-deploy
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: adage-import-function-deploy-dev
          cloud-function-name: adage_import_dev
          cloud-function-folder: jobs/etl_jobs/external/adage
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: addresses-cloud-function-deploy-dev
          cloud-function-name: addresses_import_dev
          cloud-function-folder: jobs/etl_jobs/external/addresses
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: downloads-cloud-function-deploy-dev
          cloud-function-name: downloads_dev
          cloud-function-folder: downloads-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: qualtrics-cloud-function-deploy-dev
          cloud-function-name: qualtrics_import_dev
          cloud-function-folder: qualtrics-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: appsflyer-cloud-function-deploy-dev
          cloud-function-name: appsflyer_import_dev
          cloud-function-folder: jobs/etl_jobs/external/appsflyer
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: contentful-cloud-function-deploy-dev
          cloud-function-name: contentful_dev
          cloud-function-folder: contentful-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: siren-cloud-function-deploy-dev
          cloud-function-name: siren_import_dev
          cloud-function-folder: siren-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: dms-cloud-function-deploy-dev
          cloud-function-name: dms_dev
          cloud-function-folder: dms-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: typeform-adage-reference-request-dev
          cloud-function-name: typeform_adage_reference_request_dev
          cloud-function-folder: typeform-adage-reference-request-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: metabase-archiving-dev
          cloud-function-name: metabase_archiving_dev
          cloud-function-folder: metabase-archiving-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: sendinblue-import-dev
          cloud-function-name: sendinblue_import_dev
          cloud-function-folder: sendinblue-function-source
          <<: *deploy_on_dev_commons
      - cloud-function-deploy:
          name: cold-data-dev
          cloud-function-name: cold_data_dev
          cloud-function-folder: cold-data-function-source
          <<: *deploy_on_dev_commons
      - build_and_deploy_api:
          name: build_and_deploy_api_dev
          api-instance-name: apireco-dev
          <<: *deploy_on_dev_commons
         ### temporarily removing api reco tests ###
#      - api-integration-tests:
#          env: dev
#          api_token: $API_TOKEN_DEV
#          name: api-integration-tests-dev
#          requires:
#            - dev-composer-deploy
#            - addresses-cloud-function-deploy-dev
#            - downloads-cloud-function-deploy-dev
#            - contentful-cloud-function-deploy-dev
#            - siren-cloud-function-deploy-dev
#            - dms-cloud-function-deploy-dev
#            - build_and_deploy_api_dev
#            - adage-import-function-deploy-dev
#          context:
#            - DATA_GCP_DEV
#            - Slack
#          <<: *slack-fail-post-step
      - slack-alert:
          name: slack-alert-dev
          destination_env: dev
          context: Slack
          requires:
            - dev-composer-deploy
            - addresses-cloud-function-deploy-dev
            - downloads-cloud-function-deploy-dev
            - qualtrics-cloud-function-deploy-dev
            - appsflyer-cloud-function-deploy-dev
            - contentful-cloud-function-deploy-dev
            - siren-cloud-function-deploy-dev
            - dms-cloud-function-deploy-dev
            - build_and_deploy_api_dev
            - adage-import-function-deploy-dev
            - typeform-adage-reference-request-dev
            - metabase-archiving-dev
            - cold-data-dev
            - sendinblue-import-dev
### temporarily removing api reco tests ###
#          requires:
#            - api-integration-tests-dev


###################
#  EXECUTORS
###################

executors:
  python:
    docker:
      - image: circleci/python:3.7
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD

  python310:
    docker:
      - image: circleci/python:3.10
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
  gcp-sdk:
    docker:
      - image: google/cloud-sdk:381.0.0
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD

###################
#  JOBS
###################

jobs:
  linter:
    executor: python
    working_directory: ~/data-gcp
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ checksum "linter-requirements.txt" }}
      - run:
          name: Install black
          command: |
            python3 -m venv venv-lint
            . venv-lint/bin/activate
            pip install -r linter-requirements.txt
      - save_cache:
          key: deps-{{ checksum "linter-requirements.txt" }}
          paths:
            - "venv-lint"
      - run:
          name: Run linter
          command: |
            . venv-lint/bin/activate
            black --exclude="venv-lint" --check .

  recommendation-api-build:
    executor: python
    working_directory: ~/data-gcp/recommendation/api
    steps:
      - checkout:
          path: ~/data-gcp
      - restore_cache:
          key: deps-{{ checksum "api-dev-requirements.txt" }}
      - run:
          name: Install Python deps in a venv
          command: |
            python3 -m venv venv-api
            . venv-api/bin/activate
            pip install -r api-dev-requirements.txt
      - save_cache:
          key: deps-{{ checksum "api-dev-requirements.txt" }}
          paths:
            - "venv-api"
      - persist_to_workspace:
          root: .
          paths:
            - .

  recommendation-api-tests:
    docker:
      - image: circleci/python:3.7
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
      - image: kartoza/postgis:12.4
        environment:
          POSTGRES_PASS: postgres
          POSTGRES_USER: postgres
          POSTGRES_DBNAME: db
    working_directory: ~/data-gcp/recommendation/api
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install psql
          command: sudo apt update && sudo apt install postgresql-client
      - run:
          name: Run tests
          command: |
            export PYTHONPATH=$PYTHONPATH:~/data-gcp/recommendation/api
            . venv-api/bin/activate
            ./run_tests.sh

  api-integration-tests:
    parameters:
      env:
        description: "Which environement to target"
        default: "dev"
        type: string
      api_token:
        description: "The api token (given with env var)"
        default: ""
        type: string
    docker:
      - image: postman/newman
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
    working_directory: ~/data-gcp
    steps:
      - run:
          name: Install Git
          command: |
            apk update
            apk upgrade
            apk add --no-cache bash git openssh
      - checkout
      - run:
          name: Run tests collection
          command: |
            cd recommendation/api/postman
            newman run api_integration_tests.postman_collection.json --environment <<parameters.env>>.postman_environment.json --env-var "api_token=<<parameters.api_token>>"

  orchestration-install:
    executor: python
    working_directory: ~/data-gcp/orchestration
    steps:
      - checkout:
          path: ~/data-gcp
      - restore_cache:
          key: deps-{{ checksum "airflow/orchestration-requirements.txt" }}
      - run:
          name: Install Python requirements
          command: |
            python3 -m venv venv-orchestration
            . venv-orchestration/bin/activate
            pip install -r airflow/orchestration-requirements.txt
      - save_cache:
          key: deps-{{ checksum "airflow/orchestration-requirements.txt" }}
          paths:
            - "venv-orchestration"
      - persist_to_workspace:
          root: .
          paths:
            - .

  orchestration-tests:
    executor: python
    working_directory: ~/data-gcp/orchestration
    environment:
      AIRFLOW_HOME: ~/data-gcp/orchestration
      DAG_FOLDER: /home/circleci/data-gcp/orchestration/dags
      RECOMMENDATION_SQL_INSTANCE: cloudsql-recommendation-circleci
      RECOMMENDATION_SQL_BASE: cloudsql-recommendation-circleci
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: |
            echo $GCLOUD_SERVICE_KEY > /tmp/service_account.json
            export GOOGLE_APPLICATION_CREDENTIALS="/tmp/service_account.json" 
            . venv-orchestration/bin/activate
            airflow db init
            pytest tests

  algo-training-install:
    executor: python310
    working_directory: ~/data-gcp/jobs/ml_jobs/algo_training
    steps:
      - checkout:
          path: ~/data-gcp
      - restore_cache:
          key: deps-{{ checksum "requirements.txt" }}
      - run:
          name: Install Python requirements
          command: |
            python3 -m venv venv-algo-training
            . venv-algo-training/bin/activate
            python3 -m pip install --upgrade pip
            pip3 install -r requirements.txt
      - save_cache:
          key: deps-{{ checksum "requirements.txt" }}
          paths:
            - "venv-algo-training"
      - persist_to_workspace:
          root: .
          paths:
            - .

  algo-training-tests:
    executor: python310
    working_directory: ~/data-gcp/jobs/ml_jobs/algo_training
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: |
            . venv-algo-training/bin/activate
            PYTHONPATH=. pytest tests

  record-linkage-install:
    executor: python
    working_directory: ~/data-gcp/jobs/ml_jobs/record_linkage
    steps:
      - checkout:
          path: ~/data-gcp
      - restore_cache:
          key: deps-{{ checksum "requirements.txt" }}
      - run:
          name: Install Python requirements
          command: |
            python3 -m venv venv-record-linkage
            . venv-record-linkage/bin/activate
            pip install -r requirements.txt
      - save_cache:
          key: deps-{{ checksum "requirements.txt" }}
          paths:
            - "venv-record-linkage"
      - persist_to_workspace:
          root: .
          paths:
            - .

  record-linkage-tests:
    executor: python
    working_directory: ~/data-gcp/jobs/ml_jobs/record_linkage
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: |
            . venv-record-linkage/bin/activate
            PYTHONPATH=. pytest tests
  #recommendation-db-install:
  #  executor: python
  #  working_directory: ~/data-gcp/recommendation/db
  #  steps:
  #    - checkout:
  #        path: ~/data-gcp
  #    - restore_cache:
  #        key: dependencies-{{ checksum "db-requirements.txt" }}
  #    - run:
  #        name: Install Python deps in a venv
  #        command: |
  #          python3 -m venv venv-db
  #          . venv-db/bin/activate
  #          pip install -r db-requirements.txt
  #    - save_cache:
  #        key: dependencies-{{ checksum "db-requirements.txt" }}
  #        paths:
  #          - "venv-db"
  #    - persist_to_workspace:
  #        root: .
  #        paths:
  #          - .
#
#  recommendation-db-tests:
#    docker:
#      - image: circleci/python:3.7
#        auth:
#          username: $DOCKERHUB_USER
#          password: $DOCKERHUB_PASSWORD
#      - image: circleci/postgres:12
#        environment:
#          POSTGRES_PASSWORD: postgres
#    working_directory: ~/data-gcp/recommendation/db
#    steps:
#      - attach_workspace:
#          at: .
#      - run:
#          name: Install psql
#          command: sudo apt update && sudo apt install postgresql-client
#      - run:
#          name: Run tests
#          command: |
#            export PYTHONPATH=$PYTHONPATH:~/data-gcp/recommendation/db
#            . venv-db/bin/activate
#            ./run_tests.sh
  composer-deploy:
    executor: gcp-sdk
    working_directory: ~/data-gcp/orchestration
    steps:
      - checkout:
          path: ~/data-gcp
      - run:
          name: Connect to GCP
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: Deploy to composer
          command: |
            gsutil -m rm -r gs://${COMPOSER_BUCKET}/dags
            gsutil cp -r dags gs://${COMPOSER_BUCKET}
      - run:
          name: Wait for composer to be deployed (10s x 6 times)
          command: |
            ./wait_for_dag_deployed.sh ${COMPOSER_ENV_NAME} ${REGION} airflow_monitoring 6 10


  build_and_deploy_api:
    docker:
      - image: "cimg/base:stable"
    parameters:
      api-instance-name:
        description: "API instance name"
        type: string
    working_directory: ~/data-gcp/recommendation/api
    steps:
      - checkout:
          path: ~/data-gcp
      - cloudrun/init
      - cloudrun/build:
          tag: "eu.gcr.io/${GOOGLE_PROJECT_ID}/${CIRCLE_PROJECT_REPONAME}/<< parameters.api-instance-name >>:${CIRCLE_SHA1}"
      - run:
          name: Apply latest tag
          command: |
            gcloud container images add-tag \
            eu.gcr.io/${GOOGLE_PROJECT_ID}/${CIRCLE_PROJECT_REPONAME}/<< parameters.api-instance-name >>:${CIRCLE_SHA1} \
            eu.gcr.io/${GOOGLE_PROJECT_ID}/${CIRCLE_PROJECT_REPONAME}/<< parameters.api-instance-name >>:latest
      - cloudrun/deploy:
          image: "eu.gcr.io/${GOOGLE_PROJECT_ID}/${CIRCLE_PROJECT_REPONAME}/<< parameters.api-instance-name >>:${CIRCLE_SHA1}"
          platform: managed
          region: europe-west1
          service-name: << parameters.api-instance-name >>
          unauthenticated: true

  slack-alert:
    docker:
      - image: cimg/base:stable
    parameters:
      destination_env:
        description: "The environnement on which we deploy."
        type: string
    steps:
      - run:
          name: Success
          when: always
          command: |
            exit 0
      - slack/notify:
          event: pass
          channel: alertes_data
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Le d√©ploiement sur *<<parameters.destination_env>>* est un succ√®s :rocket:"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View job",
                        "emoji": true
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "Author: $CIRCLE_USERNAME",
                      "emoji": true
                    }
                  ]
                }
              ]
            }

  cloud-function-deploy:
    executor: gcp-sdk
    parameters:
      cloud-function-name:
        description: "The cloud function name"
        type: string
      cloud-function-folder:
        description: "The cloud function code folder"
        type: string
    working_directory: ~/data-gcp
    steps:
      - checkout:
          path: ~/data-gcp
      - run:
          name: Connect to GCP
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
      - run:
          name: Deploy the function
          command: |
            cd <<parameters.cloud-function-folder>>
            gcloud functions deploy << parameters.cloud-function-name >> --region "europe-west1"  --entry-point run --source .
