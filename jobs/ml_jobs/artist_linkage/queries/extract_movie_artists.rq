PREFIX wd: <http://www.wikidata.org/entity/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX schema: <http://schema.org/>

SELECT
  ?wikidata_id
  ?artist_name_fr
  ?artist_name_en
  ?artist_description
  ?wikipedia_url
  ?img
  ?gkg_id
  (GROUP_CONCAT(DISTINCT(?alias_fr); separator=" | ") AS ?aliases_fr)
  (GROUP_CONCAT(DISTINCT(?alias_en); separator=" | ") AS ?aliases_en)
  (GROUP_CONCAT(DISTINCT ?professionLabel; separator=" | ") AS ?professions)
  (GROUP_CONCAT(DISTINCT ?genreLabel; separator=" | ") AS ?genres)
  (MIN(?birth_date) AS ?birth_date_val)
  (GROUP_CONCAT(DISTINCT ?langLabel; separator=" | ") AS ?languages_spoken)
  ?matching_score
WHERE {
  # 1. OPTIMIZATION: Filter first using UNION (checks existence only) and blank nodes ([]). This is much faster than fetching all artists and then filtering them.
  {
    { ?wikidata_id wdt:P345 [] . } # Has IMDb ID
    UNION
    { ?wikidata_id wdt:P1266 [] . } # Has Allocine ID
  }

  # 2. FILTER: Ensure it is the right type
  ?wikidata_id wdt:P31 ?type .
  VALUES ?type { wd:Q5 wd:Q215380 wd:Q216337 wd:Q641066 } # Human, Musical Group, Boys Band or Girls Band

  # 3. FETCH IDs: Now that we have the artist, fetch ALL IDs explicitly
  OPTIONAL { ?wikidata_id wdt:P345 ?imdb_id . }
  OPTIONAL { ?wikidata_id wdt:P1266 ?allocine_id . }

  # 4. MANUAL LABELS
  OPTIONAL { ?wikidata_id rdfs:label ?lbl_fr . FILTER(LANG(?lbl_fr) = "fr") }
  OPTIONAL { ?wikidata_id rdfs:label ?lbl_en . FILTER(LANG(?lbl_en) = "en") }
  OPTIONAL { ?wikidata_id rdfs:label ?lbl_mul . FILTER(LANG(?lbl_mul) = "mul") }
  BIND(COALESCE(?lbl_fr, ?lbl_mul, ?lbl_en) AS ?artist_name_fr)
  BIND(?lbl_en AS ?artist_name_en)

  OPTIONAL { ?wikidata_id schema:description ?artist_description . FILTER(LANG(?artist_description) = "fr") }

  # 5. OTHER ATTRIBUTES
  OPTIONAL { ?wikidata_id wdt:P18 ?img . }
  OPTIONAL { ?wikidata_id wdt:P2671 ?gkg_id . }
  OPTIONAL { ?wikidata_id wdt:P569 ?birth_date . }

  # 6. LISTS
  OPTIONAL { ?wikidata_id wdt:P106/rdfs:label ?professionLabel . FILTER(LANG(?professionLabel) = "fr") }
  OPTIONAL { ?wikidata_id wdt:P136/rdfs:label ?genreLabel . FILTER(LANG(?genreLabel) = "fr") }
  OPTIONAL { ?wikidata_id wdt:P1412/rdfs:label ?langLabel . FILTER(LANG(?langLabel) = "fr") }
  OPTIONAL { ?wikidata_id skos:altLabel ?alias_fr . FILTER(LANG(?alias_fr) = "fr") }
  OPTIONAL { ?wikidata_id skos:altLabel ?alias_en . FILTER(LANG(?alias_en) = "en") }

  # Wikipedia
  OPTIONAL { ?wikipedia_url_fr schema:about ?wikidata_id ; schema:isPartOf <https://fr.wikipedia.org/> . }
  OPTIONAL { ?wikipedia_url_en schema:about ?wikidata_id ; schema:isPartOf <https://en.wikipedia.org/> . }
  BIND(COALESCE(?wikipedia_url_fr, ?wikipedia_url_en) AS ?wikipedia_url)

  # 7. CALCULATE SCORE
  BIND(
    (IF(BOUND(?imdb_id), 1, 0) +
     IF(BOUND(?allocine_id), 1, 0))
  AS ?matching_score)

  # 8. FILTER: Ensure we have at least a name and one ID
  FILTER ((?artist_name_fr != "") || (?artist_name_en != ""))
}
GROUP BY ?wikidata_id ?artist_name_fr ?artist_name_en ?artist_description ?wikipedia_url ?img ?gkg_id ?matching_score
