version: 1

models: 
  - name: enriched_venue_data
    description: Data table at venue level
    columns:
      - name: venue_id
        description: "Identifier of a venue"
        tests:
          - not_null: 
              severity: error
          - unique:
              severity: error
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: string
          - relationships:
              to: ref('applicative_database_venue')
              field: venue_id
      - name: partner_id
        description: "Identifier of a partner"
        tests:
          - not_null:
              severity: error
      - name: venue_public_name
      - name: venue_name
      - name: venue_booking_email
      - name: venue_address
      - name: venue_latitude
      - name: venue_longitude
      - name: venue_department_code
      - name: venue_postal_code
      - name: venue_city
      - name: venue_siret
      - name: venue_is_virtual
      - name: venue_is_permanent
      - name: venue_managing_offerer_id
      - name: venue_creation_date
      - name: offerer_name
      - name: offerer_validation_status
        description: "Status of validation of an offerer"
        tests:
          - accepted_values:
              values: ['VALIDATED']        
      - name : venue_type_label
        description: Type of venue
        tests:
          - accepted_values:
              # description: When venue is virtuel, venue type label is always Offre numérique
              values: ['Offre numérique']
              config: 
                where: "venue_is_virtual = True"
      - name: venue_label
        tests:
          - relationships:
              to: ref('applicative_database_venue_label')
              field: venue_label      
      - name: total_bookings
        description: 'Total number of bookings generated by a venue'
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true
      - name: non_cancelled_individual_bookings
      - name: non_cancelled_collective_bookings
      - name: first_individual_booking_date
        description: First booking date on an individual offer
        tests:
          - greater_than_other_column:
              other_column: first_individual_offer_creation_date
      - name: last_individual_booking_date
        description: Last booking date on an individual offer
        tests:
          - greater_than_other_column:
              other_column: first_individual_booking_date  
      - name: first_collective_booking_date
        description: First booking date on a collective offer
        tests:
          - greater_than_other_column:
              other_column: first_collective_offer_creation_date
      - name: last_collective_booking_date
        description: Last booking date on a collective offer
        tests:
          - greater_than_other_column:
              other_column: first_collective_booking_date
      - name: non_cancelled_bookings
        description: Number of non cancelled bookings by the venue.
        tests:
          - sum_2_columns_equals_another_column:
              column_name1 : non_cancelled_individual_bookings
              column_name2 : non_cancelled_collective_bookings
      - name: used_bookings
        description: 'Total number of used bookings generated by a venue'
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true
          - sum_2_columns_equals_another_column:
              column_name1 : used_individual_bookings
              column_name2 : used_collective_bookings
      - name: used_individual_bookings
      - name: used_collective_bookings
      - name: individual_theoretic_revenue
      - name: individual_real_revenue
      - name: collective_theoretic_revenue
      - name: collective_real_revenue
      - name: first_individual_offer_creation_date
        description: First offer creation date on an individual offer
        tests:
          - greater_than_other_column:
              other_column: venue_creation_date
      - name: last_individual_offer_creation_date
        description: Last offer creation date on an individual offer
        tests:
          - greater_than_other_column:
              other_column: first_individual_offer_creation_date
      - name: first_collective_offer_creation_date
        description: First offer creation date on a collective offer
        tests:
          - greater_than_other_column:
              other_column: venue_creation_date
      - name: last_collective_offer_creation_date
        description: Last offer creation date on a collective offer
        tests:
          - greater_than_other_column:
              other_column: first_collective_offer_creation_date
      - name: first_offer_creation_date
        description: First offer creation date
        tests:
          - greater_than_other_column:
              other_column: venue_creation_date
      - name: last_offer_creation_date
        description: Last offer creation date
        tests:
          - greater_than_other_column:
              other_column: first_offer_creation_date
      - name: first_booking_date
        description: First booking date
        tests:
          - greater_than_other_column:
              other_column: first_offer_creation_date
      - name: last_booking_date
        description: Last booking date
        tests:
          - greater_than_other_column:
              other_column: first_booking_date
      - name: individual_offers_created
      - name: collective_offers_created
      - name: total_offers_created
        description: Total number of created offers by the venue
        tests:
          - sum_2_columns_equals_another_column:
              column_name1 : individual_offers_created
              column_name2 : collective_offers_created
      - name: venue_first_bookable_offer_date
      - name: venue_last_bookable_offer_date
      - name: venue_bookable_individual_offer_cnt
      - name: venue_bookable_collective_offer_cnt
      - name: venue_bookable_offer_cnt
      - name: theoretic_revenue
      - name: real_revenue
      - name: venue_humanized_id
      - name: venue_backofficev3_link
      - name: venue_region_name
      - name: venue_pc_pro_link
      - name: venue_targeted_audience
      - name: banner_url
      - name: venue_description
      - name: venue_withdrawal_details
      - name: venue_contact_phone_number
      - name: venue_contact_email
      - name: venue_contact_website
      

exposures:
  - name: enriched_venue_data
    label: "venue"
    type: dashboard
    maturity: medium
    tags: ["jeunes","pro"]
    url: metabase.com
    description: >
      blabla
        
    depends_on:
      - ref('applicative_database_venue')
      - source('raw', 'applicative_database_venue')
      
    owner:
      name: data_analyst1
      email: data_analyst1@passculture.app

