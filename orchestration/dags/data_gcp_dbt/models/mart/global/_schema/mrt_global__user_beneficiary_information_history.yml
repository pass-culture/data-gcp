version: 2
models:
  - name: mrt_global__user_beneficiary_information_history
    description: |
      Historical tracking of user beneficiary information changes over time.

      This table tracks when users modify their profile information (activity status, address, city, postal code),
      allowing analysis of user behavior patterns while protecting privacy by excluding PII fields.

      Key Features:
      - Tracks activity changes (e.g., student → unemployed)
      - Includes modification flags for each field type
      - Maintains geographical aggregations (EPCI, IRIS) without exposing precise addresses
      - Supports temporal analysis with creation_timestamp and info_history_rank

      Privacy: Excludes user_address, user_city, user_postal_code, and coordinates to protect PII.
    columns:
      - name: user_id
        description: '{{ doc("column__user_id") }}'
        data_type: STRING
        data_tests:
          - not_null

      - name: info_history_rank
        description: Sequential rank of information changes for each user (0 = first record, 1 = second, etc.)
        data_type: INT64
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: action_type
        description: Type of action that triggered the record (INFO_MODIFIED or PROFILE_COMPLETION)
        data_type: STRING
        data_tests:
          - not_null
          - accepted_values:
              values: ['INFO_MODIFIED', 'PROFILE_COMPLETION']

      - name: creation_timestamp
        description: Timestamp when the user information was modified (partitioning key with daily granularity)
        data_type: TIMESTAMP
        data_tests:
          - not_null

      - name: user_activity
        description: Current user activity status (Étudiant, Lycéen, Apprenti, etc.)
        data_type: STRING

      - name: user_previous_activity
        description: Previous user activity status before this change
        data_type: STRING

      - name: has_confirmed
        description: |
          Boolean flag indicating if the user confirmed their existing information
          (all fields remained the same compared to previous record)
        data_type: BOOL
        data_tests:
          - not_null

      - name: has_modified
        description: |
          Boolean flag indicating if the user modified any of their information
          (at least one field changed compared to previous record)
        data_type: BOOL
        data_tests:
          - not_null

      - name: has_modified_activity
        description: Boolean flag indicating if user_activity changed compared to previous record
        data_type: BOOL
        data_tests:
          - not_null

      - name: has_modified_address
        description: Boolean flag indicating if user address changed compared to previous record (normalized comparison)
        data_type: BOOL
        data_tests:
          - not_null

      - name: has_modified_city
        description: Boolean flag indicating if user city changed compared to previous record
        data_type: BOOL
        data_tests:
          - not_null

      - name: has_modified_postal_code
        description: Boolean flag indicating if user postal code changed compared to previous record
        data_type: BOOL
        data_tests:
          - not_null

      - name: epci_code
        description: Code of the EPCI (Établissement Public de Coopération Intercommunale) where the user is located
        data_type: STRING

      - name: iris_internal_id
        description: Internal identifier for the IRIS (Îlots Regroupés pour l'Information Statistique) zone where the user is located
        data_type: STRING
