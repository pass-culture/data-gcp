version: 2

semantic_models:
  - name: bookings
    description: |
      Individual booking transactions with user and venue context.
      This semantic model covers all bookings where deposit_type and user_id are not null.
      Includes user demographics, venue information, and offer details.

    model: ref('mrt_global__booking')

    defaults:
      agg_time_dimension: booking_created_at

    # ==================
    # ENTITIES
    # ==================
    entities:
      - name: booking
        type: primary
        expr: booking_id

      - name: user
        type: foreign
        expr: user_id

      - name: offer
        type: foreign
        expr: offer_id

      - name: venue
        type: foreign
        expr: venue_id

      - name: offerer
        type: foreign
        expr: offerer_id

      - name: deposit
        type: foreign
        expr: deposit_id

      - name: stock
        type: foreign
        expr: stock_id

      - name: item
        type: foreign
        expr: item_id

      - name: partner
        type: foreign
        expr: partner_id

    # ==================
    # DIMENSIONS
    # ==================
    dimensions:
      # --- Time Dimensions ---
      - name: booking_created_at
        type: time
        description: "Timestamp when the booking was created"
        type_params:
          time_granularity: day

      - name: booking_creation_date
        type: time
        description: "Date when the booking was created"
        type_params:
          time_granularity: day

      - name: booking_cancellation_date
        type: time
        description: "Date when the booking was cancelled (if applicable)"
        type_params:
          time_granularity: day

      - name: booking_used_date
        type: time
        description: "Date when the booking was used (if applicable)"
        type_params:
          time_granularity: day

      - name: stock_beginning_date
        type: time
        description: "Date when the stock/event begins"
        type_params:
          time_granularity: day

      - name: user_creation_date
        type: time
        description: "Date when the user account was created"
        type_params:
          time_granularity: day

      - name: user_activation_date
        type: time
        description: "Date when the user activated their account"
        type_params:
          time_granularity: day

      - name: user_birth_date
        type: time
        description: "User's birth date"
        type_params:
          time_granularity: day

      - name: first_deposit_creation_date
        type: time
        description: "Date when the user s first deposit was created"
        type_params:
          time_granularity: day

      # --- Booking Attributes ---
      - name: booking_status
        type: categorical
        description: "Status of the booking (e.g., confirmed, cancelled, used)"

      - name: booking_is_cancelled
        type: categorical
        description: "Whether the booking has been cancelled"

      - name: booking_is_used
        type: categorical
        description: "Whether the booking has been used"

      - name: booking_cancellation_reason
        type: categorical
        description: "Reason for booking cancellation (if cancelled)"

      - name: booking_rank
        type: categorical
        description: "Rank of this booking for the user (1st, 2nd, 3rd, etc.)"

      - name: same_category_booking_rank
        type: categorical
        description: "Rank of this booking within the same offer category for the user"

      - name: user_booking_rank
        type: categorical
        description: "Rank of this booking for the user across all categories"

      - name: booking_used_recredit_type
        type: categorical
        description: "Type of recredit used when booking was consumed"

      - name: reimbursed
        type: categorical
        description: "Whether the booking has been reimbursed"

      # --- Deposit/Financial ---
      - name: deposit_type
        type: categorical
        description: "Type of deposit used (e.g., GRANT_15_17, GRANT_18, etc.)"

      - name: deposit_reform_category
        type: categorical
        description: "Reform category associated with the deposit"

      # --- User Attributes ---
      - name: user_age_at_booking
        type: categorical
        description: "User's age at the time of booking"

      - name: user_age
        type: categorical
        description: "User's current age"

      - name: user_postal_code
        type: categorical
        description: "User's postal code"

      - name: user_department_code
        type: categorical
        description: "User's department code"

      - name: user_department_name
        type: categorical
        description: "User's department name"

      - name: user_region_name
        type: categorical
        description: "User's region name"

      - name: user_city
        type: categorical
        description: "User's city"

      - name: user_epci
        type: categorical
        description: "User's EPCI (�tablissement Public de Coop�ration Intercommunale)"

      - name: user_academy_name
        type: categorical
        description: "User's education academy"

      - name: user_density_label
        type: categorical
        description: "User's area population density label"

      - name: user_macro_density_label
        type: categorical
        description: "User's area macro density label"

      - name: user_density_level
        type: categorical
        description: "User's area density level"

      - name: user_activity
        type: categorical
        description: "User's activity status"

      - name: user_civility
        type: categorical
        description: "User's civility (Mr./Ms./etc.)"

      - name: user_is_active
        type: categorical
        description: "Whether the user account is active"

      - name: user_is_in_qpv
        type: categorical
        description: "Whether user lives in a QPV (Quartier Prioritaire de la Ville)"

      - name: user_is_unemployed
        type: categorical
        description: "Whether the user is unemployed"

      - name: user_is_in_education
        type: categorical
        description: "Whether the user is currently in education"

      - name: user_is_priority_public
        type: categorical
        description: "Whether the user is considered priority public"

      - name: user_iris_internal_id
        type: categorical
        description: "User's IRIS internal identifier"

      # --- Venue Attributes ---
      - name: venue_name
        type: categorical
        description: "Name of the venue"

      - name: venue_label
        type: categorical
        description: "Venue label/classification"

      - name: venue_type_label
        type: categorical
        description: "Type of venue (e.g., physical location, online, etc.)"

      - name: venue_postal_code
        type: categorical
        description: "Venue's postal code"

      - name: venue_department_code
        type: categorical
        description: "Venue's department code"

      - name: venue_department_name
        type: categorical
        description: "Venue's department name"

      - name: venue_region_name
        type: categorical
        description: "Venue's region name"

      - name: venue_city
        type: categorical
        description: "Venue's city"

      - name: venue_epci
        type: categorical
        description: "Venue's EPCI"

      - name: venue_academy_name
        type: categorical
        description: "Venue's education academy"

      - name: venue_density_label
        type: categorical
        description: "Venue's area population density label"

      - name: venue_macro_density_label
        type: categorical
        description: "Venue's area macro density label"

      - name: venue_density_level
        type: categorical
        description: "Venue's area density level"

      - name: venue_is_permanent
        type: categorical
        description: "Whether the venue is permanent or temporary"

      - name: venue_is_virtual
        type: categorical
        description: "Whether the venue is virtual (online)"

      - name: venue_iris_internal_id
        type: categorical
        description: "Venue's IRIS internal identifier"

      # --- Offer Attributes ---
      - name: offer_name
        type: categorical
        description: "Name of the offer"

      - name: offer_category_id
        type: categorical
        description: "Category identifier of the offer"

      - name: offer_subcategory_id
        type: categorical
        description: "Subcategory identifier of the offer"

      - name: offer_type_label
        type: categorical
        description: "Type label of the offer"

      - name: offer_sub_type_label
        type: categorical
        description: "Sub-type label of the offer"

      - name: offer_url
        type: categorical
        description: "URL to the offer"

      - name: physical_goods
        type: categorical
        description: "Whether the offer is for physical goods"

      - name: digital_goods
        type: categorical
        description: "Whether the offer is for digital goods"

      - name: event
        type: categorical
        description: "Whether the offer is for an event"

      - name: isbn
        type: categorical
        description: "ISBN number (if applicable for books)"

      - name: diversity_score
        type: categorical
        description: "Diversity score of the offer"

      # --- Offerer Attributes ---
      - name: offerer_name
        type: categorical
        description: "Name of the offerer/organization"

      - name: is_local_authority
        type: categorical
        description: "Whether the offerer is a local authority"

      - name: offerer_is_epn
        type: categorical
        description: "Whether the offerer is an EPN (Espace Public Num�rique)"

    # ==================
    # MEASURES
    # ==================
    measures:
      # --- Count Measures ---
      - name: total_bookings
        description: "Total count of bookings"
        agg: count
        expr: booking_id

      - name: unique_users
        description: "Count of unique users who made bookings"
        agg: count_distinct
        expr: user_id

      - name: unique_offers
        description: "Count of unique offers that were booked"
        agg: count_distinct
        expr: offer_id

      - name: unique_venues
        description: "Count of unique venues where bookings occurred"
        agg: count_distinct
        expr: venue_id

      - name: unique_offerers
        description: "Count of unique offerers who received bookings"
        agg: count_distinct
        expr: offerer_id

      # --- Status-Based Count Measures ---
      - name: cancelled_bookings
        description: "Count of cancelled bookings"
        agg: sum
        expr: "CASE WHEN booking_is_cancelled = true THEN 1 ELSE 0 END"

      - name: used_bookings
        description: "Count of used/consumed bookings"
        agg: sum
        expr: "CASE WHEN booking_is_used = true THEN 1 ELSE 0 END"

      - name: pending_bookings
        description: "Count of bookings that are neither cancelled nor used"
        agg: sum
        expr: "CASE WHEN booking_is_cancelled = false AND booking_is_used = false THEN 1 ELSE 0 END"

      - name: reimbursed_bookings
        description: "Count of reimbursed bookings"
        agg: sum
        expr: "CASE WHEN reimbursed = true THEN 1 ELSE 0 END"

      # --- Offer Type Measures ---
      - name: physical_goods_bookings
        description: "Count of bookings for physical goods"
        agg: sum
        expr: "CASE WHEN physical_goods = true THEN 1 ELSE 0 END"

      - name: digital_goods_bookings
        description: "Count of bookings for digital goods"
        agg: sum
        expr: "CASE WHEN digital_goods = true THEN 1 ELSE 0 END"

      - name: event_bookings
        description: "Count of bookings for events"
        agg: sum
        expr: "CASE WHEN event = true THEN 1 ELSE 0 END"

      # --- User Segment Measures ---
      - name: qpv_user_bookings
        description: "Count of bookings from users in QPV areas"
        agg: sum
        expr: "CASE WHEN user_is_in_qpv = true THEN 1 ELSE 0 END"

      - name: student_bookings
        description: "Count of bookings from users in education"
        agg: sum
        expr: "CASE WHEN user_is_in_education = true THEN 1 ELSE 0 END"

      - name: priority_public_bookings
        description: "Count of bookings from priority public users"
        agg: sum
        expr: "CASE WHEN user_is_priority_public = true THEN 1 ELSE 0 END"

      # --- Revenue Measures ---
      - name: booking_revenue
        description: "Total revenue from bookings that are both used and reimbursed"
        agg: sum
        expr: "CASE WHEN booking_is_used = true AND reimbursed = true THEN booking_intermediary_amount ELSE 0 END"

      - name: booking_expected_revenue
        description: "Total expected revenue (non cancelled bookings)"
        agg: sum
        expr: "CASE WHEN NOT booking_is_cancelled = true THEN booking_intermediary_amount ELSE 0 END"

      # --- Quantity Measures ---
      - name: booking_quantity_total
        description: "Total quantity of items/tickets booked"
        agg: sum
        expr: booking_quantity

      - name: avg_booking_quantity
        description: "Average quantity per booking"
        agg: average
        expr: booking_quantity

      # --- Statistical Measures ---
      - name: avg_booking_amount
        description: "Average booking amount"
        agg: average
        expr: booking_amount

      - name: max_booking_amount
        description: "Maximum booking amount"
        agg: max
        expr: booking_amount

      - name: min_booking_amount
        description: "Minimum booking amount (excluding zero)"
        agg: min
        expr: "CASE WHEN booking_amount > 0 THEN booking_amount ELSE NULL END"

      - name: median_booking_amount
        description: "Median booking amount"
        agg: median
        expr: booking_amount
